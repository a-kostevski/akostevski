{{- $currentPage := . -}}
{{- $currentPath := .RelPermalink -}}
{{- $currentTitle := .Title -}}
{{- $backlinks := slice -}}

{{- range where .Site.RegularPages "RelPermalink" "ne" $currentPath -}}
  {{- $content := .RawContent -}}
  {{- $permalink := $currentPage.RelPermalink -}}
  {{- $filename := path.Base $currentPage.File.Path -}}
  {{- $filenameNoExt := strings.TrimSuffix ".md" $filename -}}

  {{/* Check for wikilinks [[title]] or [[filename]] */}}
  {{- $wikiPattern1 := printf "[[%s]]" $currentTitle -}}
  {{- $wikiPattern2 := printf "[[%s]]" $filenameNoExt -}}
  {{- $wikiPattern3 := printf "[[%s|" $filenameNoExt -}}

  {{/* Check for markdown links */}}
  {{- $mdPattern := printf "](%s" $permalink -}}

  {{- if or (in $content $wikiPattern1) (in $content $wikiPattern2) (in $content $wikiPattern3) (in $content $mdPattern) -}}
    {{- $backlinks = $backlinks | append . -}}
  {{- end -}}
{{- end -}}

{{- if gt (len $backlinks) 0 -}}
<div class="backlinks">
  <h3>Backlinks</h3>
  <ul>
    {{- range $backlinks -}}
    <li>
      <a href="{{ .RelPermalink }}">{{ .Title }}</a>
      {{- if .Description -}}
      <span class="backlink-description"> â€” {{ .Description | truncate 80 }}</span>
      {{- end -}}
    </li>
    {{- end -}}
  </ul>
</div>
{{- end -}}
